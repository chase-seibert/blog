<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Django aggregation, group by day - Chase Seibert Blog</title>
<meta name="description" content="This week we had a hackathon to develop a better internal dashboard page that shows things like records added to the system over time. Not having generated many reports in Django, we had to learn how to get the Django ORM to group records by day. It&#39;s a little bit of a weak spot in the still relatively new aggregation feature, so it wasn&#39;t as easy as we expected.">


  <meta name="author" content="Chase Seibert">
  
  <meta property="article:author" content="Chase Seibert">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Chase Seibert Blog">
<meta property="og:title" content="Django aggregation, group by day">
<meta property="og:url" content="https://chase-seibert.github.io/blog/2012/02/24/django-aggregation-group-by-day.html">


  <meta property="og:description" content="This week we had a hackathon to develop a better internal dashboard page that shows things like records added to the system over time. Not having generated many reports in Django, we had to learn how to get the Django ORM to group records by day. It&#39;s a little bit of a weak spot in the still relatively new aggregation feature, so it wasn&#39;t as easy as we expected.">





  <meta name="twitter:site" content="@chase_seibert">
  <meta name="twitter:title" content="Django aggregation, group by day">
  <meta name="twitter:description" content="This week we had a hackathon to develop a better internal dashboard page that shows things like records added to the system over time. Not having generated many reports in Django, we had to learn how to get the Django ORM to group records by day. It&#39;s a little bit of a weak spot in the still relatively new aggregation feature, so it wasn&#39;t as easy as we expected.">
  <meta name="twitter:url" content="https://chase-seibert.github.io/blog/2012/02/24/django-aggregation-group-by-day.html">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2012-02-24T00:00:00+00:00">






<link rel="canonical" href="https://chase-seibert.github.io/blog/2012/02/24/django-aggregation-group-by-day.html">







  <meta name="google-site-verification" content="KbUN2yK33xTFIQa6xopl2QZyG02prTwsPwnCTjRRYMM" />






<!-- end _includes/seo.html -->



  <link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="Chase Seibert Blog Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/blog/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <link rel="icon" href="/blog/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/blog/favicon.ico" type="image/x-icon">
<a rel="me" href="https://hachyderm.io/@chase_seibert"></a>
  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/blog/">
          Chase Seibert Blog
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/blog/me/"
                
                
              >Top Posts</a>
            </li><li class="masthead__menu-item">
              <a
                href="/blog/reading-list/"
                
                
              >Reading List</a>
            </li><li class="masthead__menu-item">
              <a
                href="/blog/resume.pdf"
                
                
              >Resume</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://chase-seibert.github.io/blog/">
        <img src="/blog/images/chase-square.jpg" alt="Chase Seibert" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://chase-seibert.github.io/blog/" itemprop="url">Chase Seibert</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Director of Engineering at Dropbox</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">San Francisco, CA</span>
        </li>
      

      
        
          
            <li><a href="https://www.facebook.com/chase.seibert" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-facebook-square" aria-hidden="true"></i><span class="label">Facebook</span></a></li>
          
        
          
            <li><a href="https://github.com/chase-seibert" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.goodreads.com/chaseseibert" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-goodreads" aria-hidden="true"></i><span class="label">Goodreads</span></a></li>
          
        
          
            <li><a href="https://letterboxd.com/quasigenx/" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fas fa-fw fa-film" aria-hidden="true"></i><span class="label">Letterboxd</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/chaseseibert/" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://hachyderm.io/@chase_seibert" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-mastodon" aria-hidden="true"></i><span class="label">Mastodon</span></a></li>
          
        
          
            <li><a href="https://stackoverflow.com/users/7679" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-stack-overflow" aria-hidden="true"></i><span class="label">Stack Overflow</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Django aggregation, group by day">
    <meta itemprop="description" content="This week we had a hackathon to develop a better internal dashboard page that shows things like records added to the system over time. Not having generated many reports in Django, we had to learn how to get the Django ORM to group records by day. It&#39;s a little bit of a weak spot in the still relatively new aggregation feature, so it wasn&#39;t as easy as we expected.">
    <meta itemprop="datePublished" content="2012-02-24T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://chase-seibert.github.io/blog/2012/02/24/django-aggregation-group-by-day.html" itemprop="url">Django aggregation, group by day
</a>
          </h1>
          


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>
This week we had a hackathon to develop a better internal dashboard page that shows things like records added to the system over time. Not having generated many reports in Django, we had to learn how to get the Django ORM to group records by day. It's a little bit of a weak spot in the still relatively new <a href="https://docs.djangoproject.com/en/dev/topics/db/aggregation/">aggregation feature</a>, so it wasn't as easy as we expected.
</p>

<p>
The first pass got the job done, but was pretty slow.
</p>

<pre name="code" class="python">
import datetime
import itertools
last_14_days = datetime.datetime.today() - datetime.timedelta(14)
jobs = Job.objects.filter(date_added__gte=last_14_days)
grouped = itertools.groupby(jobs, lambda record: record.date_added.strftime("%Y-%m-%d"))
jobs_by_day = [(day, len(list(jobs_this_day))) for day, jobs_this_day in grouped]
#[('2012-02-22', 1), ('2012-02-21', 1503), ('2012-02-20', 1351), ('2012-02-19', 200), ('2012-02-18', 157), ('2012-02-17', 1423), ('2012-02-16', 1665), ('2012-02-15', 1774), ('2012-02-14', 1533), ('2012-02-13', 1635), ('2012-02-12', 170), ('2012-02-11', 147), ('2012-02-10', 958)]
</pre>

<p>
That works, but it's a little slow if you have hundreds of thousands of records in the dataset. The slowness is partially due to the ORM grabbing every field in the Job record, even though you only need date_added. Here is an optimization, assuming all you need are counts:
</p>

<pre name="code" class="python">
jobs = Job.objects.filter(date_added__gte=last_14_days).values("date_added")
grouped = itertools.groupby(jobs, lambda record: record.get("date_added").strftime("%Y-%m-%d"))
jobs_by_day = [(day, len(list(jobs_this_day))) for day, jobs_this_day in grouped]
</pre>

<p>
Even that is a lot slower than it needs to be. For the best performance, you want the grouping to happen in your database. In raw SQL, you would do something like:
</p>

<pre name="code" class="sql">
-- this syntax is Postgres specific
  select date_trunc('day', date_added),
         count(*)
    from website_job
   where date_added > now() - interval '14 days'
group by date_trunc('day', date_added)
order by date_trunc('day', date_added)

/*
2012-02-10 00:00:00:000;916
2012-02-11 00:00:00:000;147
2012-02-12 00:00:00:000;170
2012-02-13 00:00:00:000;1635
2012-02-14 00:00:00:000;1533
2012-02-15 00:00:00:000;1774
2012-02-16 00:00:00:000;1665
2012-02-17 00:00:00:000;1423
2012-02-18 00:00:00:000;157
2012-02-19 00:00:00:000;200
2012-02-20 00:00:00:000;1351
2012-02-21 00:00:00:000;1503
2012-02-22 00:00:00:000;1
*/
</pre>

<p>
You can have the Django ORM pass this raw SQL for a group by as well, as long as you don't mind that you're violating the database-independence barrier.
</p>

<pre name="code" class="python">
from django.db.models.aggregates import Count
jobs = Job.objects.filter(date_added__gte=last_14_days).extra({"day": "date_trunc('day', date_added)"}).values("day").order_by().annotate(count=Count("id"))
#[{'count': 1423, 'day': datetime.datetime(2012, 2, 17, 0, 0)}, {'count': 147, 'day': datetime.datetime(2012, 2, 11, 0, 0)}, {'count': 1351, 'day': datetime.datetime(2012, 2, 20, 0, 0)}, {'count': 1665, 'day': datetime.datetime(2012, 2, 16, 0, 0)}, {'count': 1774, 'day': datetime.datetime(2012, 2, 15, 0, 0)}, {'count': 200, 'day': datetime.datetime(2012, 2, 19, 0, 0)}, {'count': 157, 'day': datetime.datetime(2012, 2, 18, 0, 0)}, {'count': 1, 'day': datetime.datetime(2012, 2, 22, 0, 0)}, {'count': 958, 'day': datetime.datetime(2012, 2, 10, 0, 0)}, {'count': 1503, 'day': datetime.datetime(2012, 2, 21, 0, 0)}, {'count': 1635, 'day': datetime.datetime(2012, 2, 13, 0, 0)}, {'count': 1533, 'day': datetime.datetime(2012, 2, 14, 0, 0)}, {'count': 170, 'day': datetime.datetime(2012, 2, 12, 0, 0)}]
</pre>

<p>
There is some trickiness here. We're defining a new column on each result called "day", which is calculated with the <a href="http://www.postgresql.org/docs/8.1/static/functions-datetime.html">date_trunc() method</a> by Postgres. Then we're using the standard values/annotate functionality in the Django ORM aggregation framework. Notice, however, that we must clear the default ordering with an explicit order_by() in between, <a href="https://docs.djangoproject.com/en/dev/topics/db/aggregation/#interaction-with-default-ordering-or-order-by">otherwise the grouping will not work</a>.
</p>

<p>
Another solution would be to denormalize day into its own field in your model, and just use the vanilla aggregation syntax. Hopefully these kinds of aggregations will get easier in future versions of Django.
</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/blog/tags/#django" class="page__taxonomy-item p-category" rel="tag">django</a><span class="sep">, </span>
    
      <a href="/blog/tags/#postgres" class="page__taxonomy-item p-category" rel="tag">postgres</a>
    
    </span>
  </p>






    <p class="page__date">
        <strong><i class="fas fa-fw fa-edit" aria-hidden="true"></i> GitHub:</strong>
        <a href="https://github.com/chase-seibert/blog/blob/master/_posts/2012-02-24-django-aggregation-group-by-day.html">_posts/2012-02-24-django-aggregation-group-by-day.html</a>
    </p>

        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2012-02-24T00:00:00+00:00">February 24, 2012</time></p>

      </footer>

      

      
  <nav class="pagination">
    
      <a href="/blog/2012/02/17/save-a-screenshot-to-dropbox-with-a-keyboard-shortcut.html" class="pagination--pager" title="Save a screenshot to Dropbox with a keyboard shortcut">Previous</a>
    
    
      <a href="/blog/2012/03/16/adding-a-first-method-to-djangos-queryset.html" class="pagination--pager" title="Adding a .first() method to Django’s QuerySet">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
</div>

      
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
      <li><a href="/blog/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2025 <a href="https://chase-seibert.github.io">Chase Seibert Blog</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/blog/assets/js/main.min.js"></script>









  </body>
</html>
