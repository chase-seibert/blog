<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Enabling SOLR autocommit with a custom Haystack backend - Chase Seibert Blog</title>
<meta name="description" content="By default Django Haystack makes updates to your Solr index available for searching immediately. It does this in the simplest way possible, it commits every single update individually. That can be quite slow. I have an index with 35 million records, and under heavy write load commits of 1,000 records can slow down and take up to 5 seconds for each chunk. In extreme cases, Solr can refuse to accept that much write load at once, and throw an exception like the following:">


  <meta name="author" content="Chase Seibert">
  
  <meta property="article:author" content="Chase Seibert">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Chase Seibert Blog">
<meta property="og:title" content="Enabling SOLR autocommit with a custom Haystack backend">
<meta property="og:url" content="https://chase-seibert.github.io/blog/2014/07/02/haystack-solr-autocommit.html">


  <meta property="og:description" content="By default Django Haystack makes updates to your Solr index available for searching immediately. It does this in the simplest way possible, it commits every single update individually. That can be quite slow. I have an index with 35 million records, and under heavy write load commits of 1,000 records can slow down and take up to 5 seconds for each chunk. In extreme cases, Solr can refuse to accept that much write load at once, and throw an exception like the following:">





  <meta name="twitter:site" content="@chase_seibert">
  <meta name="twitter:title" content="Enabling SOLR autocommit with a custom Haystack backend">
  <meta name="twitter:description" content="By default Django Haystack makes updates to your Solr index available for searching immediately. It does this in the simplest way possible, it commits every single update individually. That can be quite slow. I have an index with 35 million records, and under heavy write load commits of 1,000 records can slow down and take up to 5 seconds for each chunk. In extreme cases, Solr can refuse to accept that much write load at once, and throw an exception like the following:">
  <meta name="twitter:url" content="https://chase-seibert.github.io/blog/2014/07/02/haystack-solr-autocommit.html">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2014-07-02T00:00:00+00:00">






<link rel="canonical" href="https://chase-seibert.github.io/blog/2014/07/02/haystack-solr-autocommit.html">







  <meta name="google-site-verification" content="KbUN2yK33xTFIQa6xopl2QZyG02prTwsPwnCTjRRYMM" />






<!-- end _includes/seo.html -->



  <link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="Chase Seibert Blog Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/blog/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <link rel="icon" href="/blog/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/blog/favicon.ico" type="image/x-icon">
<a rel="me" href="https://hachyderm.io/@chase_seibert"></a>
  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/blog/">
          Chase Seibert Blog
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/blog/me/"
                
                
              >Top Posts</a>
            </li><li class="masthead__menu-item">
              <a
                href="/blog/reading-list/"
                
                
              >Reading List</a>
            </li><li class="masthead__menu-item">
              <a
                href="/blog/resume.pdf"
                
                
              >Resume</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://chase-seibert.github.io/blog/">
        <img src="/blog/images/chase-square.jpg" alt="Chase Seibert" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://chase-seibert.github.io/blog/" itemprop="url">Chase Seibert</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Director of Engineering at Dropbox</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">San Francisco, CA</span>
        </li>
      

      
        
          
            <li><a href="https://www.facebook.com/chase.seibert" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-facebook-square" aria-hidden="true"></i><span class="label">Facebook</span></a></li>
          
        
          
            <li><a href="https://github.com/chase-seibert" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.goodreads.com/chaseseibert" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-goodreads" aria-hidden="true"></i><span class="label">Goodreads</span></a></li>
          
        
          
            <li><a href="https://letterboxd.com/quasigenx/" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fas fa-fw fa-film" aria-hidden="true"></i><span class="label">Letterboxd</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/chaseseibert/" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://hachyderm.io/@chase_seibert" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-mastodon" aria-hidden="true"></i><span class="label">Mastodon</span></a></li>
          
        
          
            <li><a href="https://stackoverflow.com/users/7679" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-stack-overflow" aria-hidden="true"></i><span class="label">Stack Overflow</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Enabling SOLR autocommit with a custom Haystack backend">
    <meta itemprop="description" content="By default Django Haystack makes updates to your Solr index available forsearching immediately. It does this in the simplest way possible, it commits every single update individually.That can be quite slow. I have an index with 35 million records, and under heavy write load commits of 1,000records can slow down and take up to 5 seconds for each chunk. In extreme cases, Solr can refuse to acceptthat much write load at once, and throw an exception like the following:">
    <meta itemprop="datePublished" content="2014-07-02T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://chase-seibert.github.io/blog/2014/07/02/haystack-solr-autocommit.html" itemprop="url">Enabling SOLR autocommit with a custom Haystack backend
</a>
          </h1>
          


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>By default <a href="http://haystacksearch.org/">Django Haystack</a> makes updates to your Solr index available for
searching immediately. It does this in the simplest way possible, it commits every single update individually.
That can be quite slow. I have an index with 35 million records, and under heavy write load commits of 1,000
records can slow down and take up to 5 seconds for each chunk. In extreme cases, Solr can refuse to accept
that much write load at once, and throw an exception like the following:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;response&gt;</span>
    <span class="nt">&lt;lst</span> <span class="na">name=</span><span class="s">"responseHeader"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;int</span> <span class="na">name=</span><span class="s">"status"</span><span class="nt">&gt;</span>503<span class="nt">&lt;/int&gt;</span>
        <span class="nt">&lt;int</span> <span class="na">name=</span><span class="s">"QTime"</span><span class="nt">&gt;</span>1492<span class="nt">&lt;/int&gt;</span>
    <span class="nt">&lt;/lst&gt;</span>
    <span class="nt">&lt;lst</span> <span class="na">name=</span><span class="s">"error"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;str</span> <span class="na">name=</span><span class="s">"msg"</span><span class="nt">&gt;</span>Error opening new searcher. exceeded limit of maxWarmingSearchers=2, try again later.<span class="nt">&lt;/str&gt;</span>
        <span class="nt">&lt;int</span> <span class="na">name=</span><span class="s">"code"</span><span class="nt">&gt;</span>503<span class="nt">&lt;/int&gt;</span>
    <span class="nt">&lt;/lst&gt;</span>
<span class="nt">&lt;/response&gt;</span></code></pre></figure>

<p>Investigating this error, I turned up a <a href="http://stackoverflow.com/questions/7512945/solr-error-opening-new-searcher-exceeded-limit-of-maxwarmingsearchers-2-try">Stackoverflow post</a>
basically saying to not make so many commits. That turned up a <a href="https://github.com/toastdriven/django-haystack/pull/624">Haystack pull request</a>
to make manual commits optional.</p>

<p>You can see the basic issue by looking at the logs that Haystack creates each time it issues a write request to the
Solr REST API:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">Finished <span class="s1">'http://localhost:8080/solr/my_index/update/?commit=true'</span> <span class="o">(</span>post<span class="o">)</span> with body <span class="s1">'u'</span>&lt;add&gt;...<span class="s1">' in 0.010 seconds.</span></code></pre></figure>

<p>As of Solr 4.0, we have much more performant options for bulk indexing. A <a href="http://wiki.apache.org/solr/NearRealtimeSearch">common setup</a>
is to use <code class="language-plaintext highlighter-rouge">autocommit</code> (set by default to 15 seconds) and abstain from manually committing by passing <code class="language-plaintext highlighter-rouge">commit=false</code> on
the REST API URL. Though Haystack supports passing a commit boolean to the various back-end implementations of <code class="language-plaintext highlighter-rouge">update</code>,
<code class="language-plaintext highlighter-rouge">remove</code> and <code class="language-plaintext highlighter-rouge">clear</code>, this parameter is never explicitly set. Instead, you can <a href="http://www.wellfireinteractive.com/blog/custom-haystack-elasticsearch-backend/">implement your own</a>
search back-end subclass to pass this value.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">haystack.backends.solr_backend</span> <span class="kn">import</span> <span class="n">SolrEngine</span><span class="p">,</span> <span class="n">SolrSearchBackend</span>


<span class="k">class</span> <span class="nc">AutoCommitSolrSearchBackend</span><span class="p">(</span><span class="n">SolrSearchBackend</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AutoCommitSolrSearchBackend</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">update</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="n">commit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_or_string</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AutoCommitSolrSearchBackend</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">remove</span><span class="p">(</span><span class="n">obj_or_string</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="n">commit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="o">=</span><span class="p">[],</span> <span class="n">commit</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AutoCommitSolrSearchBackend</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">clear</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="n">commit</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AutoCommitSolrEngine</span><span class="p">(</span><span class="n">SolrEngine</span><span class="p">):</span>
    <span class="s">''' the built-in Solr engine in Haystack performs a manual commit after each update/add/remove/clear. This
    is really slow. Solr is configured by default to auto-commit changes every 15 seconds, so there is no need to
    commit manually on every update.
    '''</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="n">AutoCommitSolrSearchBackend</span></code></pre></figure>

<p>Then you can use this new <code class="language-plaintext highlighter-rouge">AutoCommitSolrEngine</code> in your <code class="language-plaintext highlighter-rouge">HAYSTACK_CONNECTIONS</code> setting.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">HAYSTACK_CONNECTIONS</span> <span class="o">=</span> <span class="p">{</span>
     <span class="s">'default'</span><span class="p">:</span> <span class="p">{</span>
         <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'myapp.serach.AutoCommitSolrEngine'</span><span class="p">,</span>
         <span class="s">'URL'</span><span class="p">:</span> <span class="s">'http://localhost:8080/solr/my_index'</span><span class="p">,</span>
     <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p><strong>Note: By default, indexed items will not show up in searches right away. That’s what soft-commit is for.</strong></p>

<blockquote>
  <p>Hard commits are about durability, soft commits are about visibility. <a href="http://searchhub.org/2013/08/23/understanding-transaction-logs-softcommit-and-commit-in-sorlcloud/">Understanding Transaction Logs, Soft Commit and Commit in SolrCloud - Erick Erickson</a></p>
</blockquote>

<p>To make your auto-committed items available to search in a timely fashion, you must set a <code class="language-plaintext highlighter-rouge">autoSoftCommit.maxTime</code>
in your Solr config. This is <em>NOT</em> set by default.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml">    <span class="c">&lt;!-- softAutoCommit is like autoCommit except it causes a
         'soft' commit which only ensures that changes are visible
         but does not ensure that data is synced to disk.  This is
         faster and more near-realtime friendly than a hard commit.
      --&gt;</span>
    <span class="nt">&lt;autoSoftCommit&gt;</span>
      <span class="nt">&lt;maxTime&gt;</span>1000<span class="nt">&lt;/maxTime&gt;</span>
    <span class="nt">&lt;/autoSoftCommit&gt;</span></code></pre></figure>

<p>Alternately, you can set <code class="language-plaintext highlighter-rouge">autoCommit.openSearcher</code> to <code class="language-plaintext highlighter-rouge">true</code>, which will cause a new searcher worker to be instantiated
every time you auto-commit. This could slow down the first searches that come in after an auto commit, however.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/blog/tags/#haystack" class="page__taxonomy-item p-category" rel="tag">haystack</a><span class="sep">, </span>
    
      <a href="/blog/tags/#python" class="page__taxonomy-item p-category" rel="tag">python</a><span class="sep">, </span>
    
      <a href="/blog/tags/#solr" class="page__taxonomy-item p-category" rel="tag">solr</a>
    
    </span>
  </p>






    <p class="page__date">
        <strong><i class="fas fa-fw fa-edit" aria-hidden="true"></i> GitHub:</strong>
        <a href="https://github.com/chase-seibert/blog/blob/master/_posts/2014-07-02-haystack-solr-autocommit.md">_posts/2014-07-02-haystack-solr-autocommit.md</a>
    </p>

        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2014-07-02T00:00:00+00:00">July 2, 2014</time></p>

      </footer>

      

      
  <nav class="pagination">
    
      <a href="/blog/2014/06/20/debugging-ie7-crashes.html" class="pagination--pager" title="Debugging an IE7 browser crash (manual git bisect)">Previous</a>
    
    
      <a href="/blog/2014/07/18/dimensional-schema-hierarchy-bridge-slowly-changing.html" class="pagination--pager" title="Designing a Dimensional Schema for a hierarchy that can change over time">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
</div>

      
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
      <li><a href="/blog/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2025 <a href="https://chase-seibert.github.io">Chase Seibert Blog</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/blog/assets/js/main.min.js"></script>









  </body>
</html>
