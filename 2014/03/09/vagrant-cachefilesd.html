<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Speed up your Vagrant NFS shares with cachefilesd - Chase Seibert Blog</title>
<meta name="description" content="Most web based tech startups are deploying to cloud hosted Linux machines. At the same time, only a small percentage of engineers actually run Linux on their development desktops. Enter Vagrant, an easy way to provision local Linux development environments in a virtual machine.">


  <meta name="author" content="Chase Seibert">
  
  <meta property="article:author" content="Chase Seibert">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Chase Seibert Blog">
<meta property="og:title" content="Speed up your Vagrant NFS shares with cachefilesd">
<meta property="og:url" content="https://chase-seibert.github.io/blog/2014/03/09/vagrant-cachefilesd.html">


  <meta property="og:description" content="Most web based tech startups are deploying to cloud hosted Linux machines. At the same time, only a small percentage of engineers actually run Linux on their development desktops. Enter Vagrant, an easy way to provision local Linux development environments in a virtual machine.">





  <meta name="twitter:site" content="@chase_seibert">
  <meta name="twitter:title" content="Speed up your Vagrant NFS shares with cachefilesd">
  <meta name="twitter:description" content="Most web based tech startups are deploying to cloud hosted Linux machines. At the same time, only a small percentage of engineers actually run Linux on their development desktops. Enter Vagrant, an easy way to provision local Linux development environments in a virtual machine.">
  <meta name="twitter:url" content="https://chase-seibert.github.io/blog/2014/03/09/vagrant-cachefilesd.html">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2014-03-09T00:00:00+00:00">






<link rel="canonical" href="https://chase-seibert.github.io/blog/2014/03/09/vagrant-cachefilesd.html">







  <meta name="google-site-verification" content="KbUN2yK33xTFIQa6xopl2QZyG02prTwsPwnCTjRRYMM" />






<!-- end _includes/seo.html -->



  <link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="Chase Seibert Blog Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/blog/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <link rel="icon" href="/blog/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/blog/favicon.ico" type="image/x-icon">
<a rel="me" href="https://hachyderm.io/@chase_seibert"></a>
  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/blog/">
          Chase Seibert Blog
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/blog/me/"
                
                
              >Top Posts</a>
            </li><li class="masthead__menu-item">
              <a
                href="/blog/reading-list/"
                
                
              >Reading List</a>
            </li><li class="masthead__menu-item">
              <a
                href="/blog/resume.pdf"
                
                
              >Resume</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://chase-seibert.github.io/blog/">
        <img src="/blog/images/chase-square.jpg" alt="Chase Seibert" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://chase-seibert.github.io/blog/" itemprop="url">Chase Seibert</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Director of Engineering at Dropbox</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">San Francisco, CA</span>
        </li>
      

      
        
          
            <li><a href="https://www.facebook.com/chase.seibert" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-facebook-square" aria-hidden="true"></i><span class="label">Facebook</span></a></li>
          
        
          
            <li><a href="https://github.com/chase-seibert" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.goodreads.com/chaseseibert" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-goodreads" aria-hidden="true"></i><span class="label">Goodreads</span></a></li>
          
        
          
            <li><a href="https://letterboxd.com/quasigenx/" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fas fa-fw fa-film" aria-hidden="true"></i><span class="label">Letterboxd</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/chaseseibert/" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://hachyderm.io/@chase_seibert" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-mastodon" aria-hidden="true"></i><span class="label">Mastodon</span></a></li>
          
        
          
            <li><a href="https://stackoverflow.com/users/7679" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-stack-overflow" aria-hidden="true"></i><span class="label">Stack Overflow</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Speed up your Vagrant NFS shares with cachefilesd">
    <meta itemprop="description" content="Most web based tech startups are deploying to cloud hosted Linux machines. At the same time, only a small percentage of engineers actually run Linux on their development desktops. Enter Vagrant, an easy way to provision local Linux development environments in a virtual machine.">
    <meta itemprop="datePublished" content="2014-03-09T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://chase-seibert.github.io/blog/2014/03/09/vagrant-cachefilesd.html" itemprop="url">Speed up your Vagrant NFS shares with cachefilesd
</a>
          </h1>
          


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>Most web based tech startups are deploying to cloud hosted Linux machines. At the same time, only a small percentage of engineers actually run Linux on their development desktops. Enter <a href="http://www.vagrantup.com/">Vagrant</a>, an easy way to provision local Linux development environments in a virtual machine.</p>

<p>At my current startup, we’re using Vagrant with our regular <a href="http://www.getchef.com/chef/">Chef</a> recipes so that the configuration of development matches production as closely as possible. The primary difference is the way the code is loaded. Instead of being saved on the VM itself, it’s mounted via a shared directory with the host. That way, the 1/4 or so of the engineers on the team that use a graphical IDE as their editor get the super fast file access they require.</p>

<p>In that setup, although we’re editing files on the host system, we run git inside the guest VM. This is done to support <a href="http://git-scm.com/book/en/Customizing-Git-Git-Hooks">git hooks</a> that rely on our dependencies that are only installed inside the VM.</p>

<h1 id="virtualbox-shared-folders-are-slow">VirtualBox Shared Folders are Slow</h1>

<p>Right at the start, we noticed considerable lag running git commands in this setup. At this point we were using the default <a href="http://docs.vagrantup.com/v2/synced-folders/basic_usage.html">synced folder</a> mechanism, VirtualBox shared folders. Our <code class="language-plaintext highlighter-rouge">Vagrantfile</code> had a section like this:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"~/projects"</span><span class="p">,</span> <span class="s2">"/home/vagrant/projects"</span></code></pre></figure>

<p>After a little research, we found that there were <a href="http://jsosic.wordpress.com/tag/shared-folders/">known issues</a> with VirtualBox shared folders being <a href="https://forums.virtualbox.org/viewtopic.php?f=6&amp;t=55044">very slow for large folders</a>. The recommended solution was to use <a href="http://en.wikipedia.org/wiki/Network_File_System">NFS</a>.</p>

<h1 id="using-nfs-with-vagrant">Using NFS with Vagrant</h1>

<p>Vagrant makes switching to NFS fairly easy. It’s all pretty seamless with a simple configuration change, except for the fact that folder permissions owner and group can only be set to the vagrant user. For us, this involved some chef recipe tweaking; as we normally place the files in the developer’s home directory.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"~/projects"</span><span class="p">,</span> <span class="s2">"/home/vagrant/projects"</span><span class="p">,</span> <span class="ss">type: </span><span class="s2">"nfs"</span></code></pre></figure>

<p>You will need to do a <code class="language-plaintext highlighter-rouge">vagrant reload</code> to update the config.</p>

<p><em>Note: don’t try to use NFS4 with <code class="language-plaintext highlighter-rouge">mount_options: ['vers=4']</code> on a Mac host. The Mac NFS4 implementation is <a href="http://dfusion.com.au/wiki/tiki-index.php?page=NFSv4+on+Apple+OS+X">not ready for primetime</a>.</em>.</p>

<h1 id="futher-performance-improvements-with-cachefilesd">Futher Performance Improvements with cachefilesd</h1>

<p>Git commands were still not running instantly, which is part of the benefit of using git in the first place. Enter <a href="http://linux.die.net/man/8/cachefilesd">cachefilesd</a>, a Linux service that caches NFS file access.</p>

<p>You can install it manually in your Vagrant instance, just to see what the performance difference is.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>apt-get <span class="nb">install </span>cachefilesd
<span class="nb">sudo echo</span> <span class="s2">"RUN=yes"</span> <span class="o">&gt;</span> /etc/default/cachefilesd</code></pre></figure>

<p>Then, update your <code class="language-plaintext highlighter-rouge">Vagrantfile</code> as follows:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"~/projects"</span><span class="p">,</span> <span class="s2">"/home/vagrant/projects"</span><span class="p">,</span> <span class="ss">type: </span><span class="s2">"nfs"</span><span class="p">,</span> <span class="ss">mount_options: </span><span class="p">[</span><span class="s1">'rw'</span><span class="p">,</span> <span class="s1">'vers=3'</span><span class="p">,</span> <span class="s1">'tcp'</span><span class="p">,</span> <span class="s1">'fsc'</span><span class="p">]</span>  <span class="c1"># the fsc is for cachedfilesd</span></code></pre></figure>

<p>You will need to do a <code class="language-plaintext highlighter-rouge">vagrant reload</code> to update the config. You can check that cachefilesd is actually working by listing the cache directory inside the VM:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> /var/cache/fscache/
<span class="nb">sudo du</span> <span class="nt">-sh</span></code></pre></figure>

<p>If you are using Chef, you can install cachefilesd with something like the following:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">package</span> <span class="s2">"cachefilesd"</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:install</span>
<span class="k">end</span>

<span class="n">file</span> <span class="s2">"/etc/default/cachefilesd"</span> <span class="k">do</span>
  <span class="n">content</span> <span class="o">&lt;&lt;-</span><span class="no">EOS</span><span class="sh">
RUN=yes
</span><span class="no">  EOS</span>
  <span class="n">action</span> <span class="ss">:create</span>
  <span class="n">mode</span> <span class="mo">0755</span>
<span class="k">end</span></code></pre></figure>

<h1 id="leveraging-gits-preloadindex-setting">Leveraging Git’s preloadindex setting</h1>

<p>I also found a git setting specifically designed to <a href="http://git-scm.com/docs/git-config">increase peformance over NFS</a>. Hopefully this will be made a <a href="http://git.661346.n2.nabble.com/git-status-takes-30-seconds-on-Windows-7-Why-td7580816.html#a7580853">default git setting</a> soon. Simply run the following.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git config core.preloadindex <span class="nb">true</span></code></pre></figure>

<h1 id="measuring-the-performance-difference">Measuring the Performance Difference</h1>

<p>Here are the stats for our git repository. This was in a repo with approximately 33,000 files. The host machine is OSX 10.9 with an SSD. The guest VM was configured with 2GB RAM and 2 CPUs. My methodology was to run <code class="language-plaintext highlighter-rouge">git status</code> four times for each configuration. The first time is noted separately, and the last three times are averaged. Time was measured using the <code class="language-plaintext highlighter-rouge">time</code> command.</p>

<p><img src="/blog/images/nfsgit.png" alt="performance numbers" /></p>

<h1 id="still-looking-for-a-better-solution">Still looking for a better solution</h1>

<p>Git over NFS is <a href="http://git.661346.n2.nabble.com/hosting-git-on-a-nfs-td1489016.html">not ideal</a>, even when everything is “local”. The main problem seems to be very large repos (tens of thousands of files or more). Smaller repos still perform in the hundreds of milliseconds.</p>

<p>Other stuff to try:</p>

<ul>
  <li>Git 1.7 added <a href="http://jasonkarns.com/blog/subdirectory-checkouts-with-git-sparse-checkout/">sparse checkouts</a></li>
  <li>Git also has an <a href="http://git-scm.com/docs/git-update-index#_using_%60%60assume_unchanged%27%27_bit">–assume-unchanged</a> that can be used to exlcude directories that don’t often change.</li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/blog/tags/#vagrant" class="page__taxonomy-item p-category" rel="tag">vagrant</a>
    
    </span>
  </p>






    <p class="page__date">
        <strong><i class="fas fa-fw fa-edit" aria-hidden="true"></i> GitHub:</strong>
        <a href="https://github.com/chase-seibert/blog/blob/master/_posts/2014-03-09-vagrant-cachefilesd.md">_posts/2014-03-09-vagrant-cachefilesd.md</a>
    </p>

        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2014-03-09T00:00:00+00:00">March 9, 2014</time></p>

      </footer>

      

      
  <nav class="pagination">
    
      <a href="/blog/2014/02/25/celery-fail-silently-context-manager.html" class="pagination--pager" title="Celery fail silently context manager">Previous</a>
    
    
      <a href="/blog/2014/03/21/python-multilevel-argparse.html" class="pagination--pager" title="Multi-level argparse in Python (parsing commands like git)">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
</div>

      
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
      <li><a href="/blog/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2025 <a href="https://chase-seibert.github.io">Chase Seibert Blog</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/blog/assets/js/main.min.js"></script>









  </body>
</html>
